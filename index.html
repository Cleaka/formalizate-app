<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osinergmin - Asistente de Formalizaci√≥n (GLP)</title>
    <style>
        :root {
            --primary: #005A9C;
            --secondary: #00A9E0;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }
        .step { display: none; }
        .step.active { display: block; }
        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
            text-align: center;
        }
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .option-card {
            border: 2px solid var(--light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        .option-card:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .option-card.selected {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.1);
        }
        .option-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .option-card h3 {
            color: var(--dark);
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .option-card p {
            font-size: 0.9em;
            color: #777;
            font-weight: bold;
        }
        #question-display {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .question-text {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            text-align: center;
        }
        .help-text {
            font-size: 1.0em;
            color: var(--primary);
            background-color: rgba(0, 169, 224, 0.05);
            border: 1px dashed var(--secondary);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .answer-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .btn-option {
            display: block;
            width: 100%;
            background-color: #fff;
            color: var(--dark);
            padding: 20px;
            border: 2px solid var(--light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }
        .btn-option:hover {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.05);
        }
        .btn-option.selected {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.1);
            color: var(--primary);
        }
        .answer-options.binary {
             grid-template-columns: 1fr 1fr;
        }
        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: center;
        }
        .dimensions-grid label {
            font-weight: bold;
            text-align: right;
            font-size: 1.2em;
        }
        input[type="number"] {
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:hover { background-color: #007bbd; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .btn-prev { background-color: var(--dark); }
        .btn-prev:hover { background-color: #4a637c; }
        .btn-eval { background-color: var(--success); }
        .btn-eval:hover { background-color: #219653; }
        .result {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .result h3 { font-size: 1.8em; margin-bottom: 10px; }
        .result-icon { font-size: 4em; margin-bottom: 15px; }
        .success {
            background-color: rgba(39, 174, 96, 0.1);
            border: 2px solid var(--success);
            color: #219653;
        }
        .danger {
            background-color: rgba(231, 76, 60, 0.1);
            border: 2px solid var(--danger);
            color: #c0392b;
        }
        .capacity-box {
            background-color: #fff;
            border: 2px solid var(--success);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: left;
        }
        .capacity-box p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .capacity-box .final-capacity {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
        }
        .failures-list {
            margin-top: 20px;
            text-align: left;
        }
        .failure-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid var(--danger);
            background-color: rgba(231, 76, 60, 0.05);
            color: #c0392b;
            font-weight: bold;
        }
        .recommendation-item {
             padding: 15px;
            margin-top: 20px;
            border-left: 5px solid var(--warning);
            background-color: rgba(243, 156, 18, 0.1);
            color: #d35400;
            font-weight: 500;
            text-align: left;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--light);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: var(--secondary);
            width: 0%;
            transition: width 0.5s ease;
        }
        .dni-section {
            background-color: rgba(0, 169, 224, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        .declaration {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üõ°Ô∏è Osinergmin</div>
            <div class="subtitle">Asistente de Pre-evaluaci√≥n para Venta de GLP</div>
        </header>

        <div class="dni-section card">
            <h2>¬°Bienvenido! üëã</h2>
            <p style="text-align: center; margin-bottom: 20px;">Te ayudaremos a revisar si tu local cumple los requisitos de seguridad. Para guardar tu avance y usarlo en la oficina, ingresa tu DNI.</p>
            <div class="form-group">
                <label for="dni">Ingresa tu DNI (8 d√≠gitos):</label>
                <input type="tel" id="dni" placeholder="Ej: 12345678" maxlength="8" pattern="[0-9]{8}">
            </div>
            <button class="btn" id="saveDni">Guardar DNI y Empezar</button>
            <div id="dniMessage" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>
        </div>

        <div class="card" id="wizard-container" style="display: none;">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>

            <div class="step active" id="step1">
                <h2>1. ¬øC√≥mo almacenar√°s el gas?</h2>
                <div class="option-grid">
                    <div class="option-card" data-option="1">
                        <div class="option-icon">üóÑÔ∏è</div>
                        <h3>En Rack / Jaula</h3>
                        <p>Hasta 120 kg</p>
                    </div>
                    <div class="option-card" data-option="2">
                        <div class="option-icon">üè†</div>
                        <h3>Local con Techo</h3>
                        <p>Hasta 5,000 kg</p>
                    </div>
                    <div class="option-card" data-option="3">
                        <div class="option-icon">‚òÄÔ∏è</div>
                        <h3>Local sin Techo</h3>
                        <p>Hasta 50,000 kg</p>
                    </div>
                </div>
            </div>

            <div class="step" id="step2">
                <h2 id="question-title">2. Revisi√≥n de Seguridad</h2>
                <div id="question-display"></div>
                <div class="navigation-buttons">
                    <button class="btn btn-prev" id="prevQuestion">‚¨ÖÔ∏è Anterior</button>
                    <button class="btn" id="nextQuestion">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="step" id="step3">
                <h2>Resultado de la Pre-evaluaci√≥n</h2>
                <div id="result-container"></div>
                <button class="btn" id="restart">Revisar de Nuevo</button>
            </div>
        </div>

        <div class="declaration hidden" id="declaration">
            <h2>Declaraci√≥n Jurada</h2>
            <p><strong>DNI:</strong> <span id="decl-dni"></span></p>
            <p>Con esta fecha, declaro que las respuestas marcadas son verdaderas y reflejan la realidad de mi local.</p>
            <div id="declaration-content"></div>
            <button class="btn" id="printDeclaration">Imprimir DJ</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const TRANSFORMERMINDISTANCE = 7.6;
        const VENTILATIONMINAREA = 6;
        const WALL_CLEARANCE = 4.6;
        const MINDIMENSIONTOTAL = WALL_CLEARANCE * 2;

        // --- PREGUNTAS ---
        const questionSets = {
            1: [
                {
                    id: 'has_retiro',
                    text: '¬øTu casa tiene un "retiro"? (Un espacio o jard√≠n entre tu puerta y la vereda)',
                    type: 'binary',
                    options: ['S√≠, tengo retiro', 'No, mi casa da a la vereda'],
                    critical: true,
                    condition: (answer) => answer === 'S√≠, tengo retiro',
                    failureMessage: 'Para usar un Rack (jaula), es obligatorio tener un espacio de retiro. No puede estar en la vereda.'
                },
                {
                    id: 'businesses',
                    text: '‚ö†Ô∏è ¬°Atenci√≥n! ¬øAlguno de tus vecinos (costados, atr√°s, frente) tiene un taller de soldadura, mec√°nica, carpinter√≠a o un negocio que bote chispas?',
                    type: 'binary',
                    options: ['S√≠, hay un taller cerca', 'No, son casas o bodegas'],
                    critical: true,
                    condition: (answer) => answer === 'No, son casas o bodegas',
                    failureMessage: 'No puedes almacenar gas cerca de negocios que generen chispas (talleres, soldadura) por alto riesgo de explosi√≥n.'
                },
                {
                    id: 'transformer_nearby',
                    text: '¬øHay alg√∫n transformador el√©ctrico (ese gris en el poste) cerca?',
                    type: 'binary',
                    options: ['S√≠, hay uno cerca', 'No hay ninguno cerca'],
                    critical: false 
                },
                {
                    id: 'transformer_distance',
                    text: '¬øA cu√°ntos metros est√° el transformador de tu RACK?',
                    type: 'number',
                    helpText: `Mide en l√≠nea recta desde donde ir√° el rack hasta el transformador. La distancia m√≠nima es ${TRANSFORMERMINDISTANCE} metros.`,
                    critical: true,
                    dependsOn: { id: 'transformer_nearby', value: 'S√≠, hay uno cerca' }, 
                    condition: (answer) => parseFloat(answer) >= TRANSFORMERMINDISTANCE,
                    failureMessage: `La distancia m√≠nima al transformador debe ser ${TRANSFORMERMINDISTANCE} metros. El riesgo el√©ctrico es muy alto.`
                }
            ],
            2: [
                {
                    id: 'ventilation_type',
                    text: '¬øLa ventilaci√≥n de tu almac√©n es PERMANENTE? (Ej: rejas, calados, un hueco que no se puede cerrar)',
                    type: 'binary',
                    options: ['S√≠, es permanente (rejas)', 'No, tiene ventanas o se cierra'],
                    critical: true,
                    condition: (answer) => answer === 'S√≠, es permanente (rejas)',
                    failureMessage: 'La ventilaci√≥n debe ser permanente (con rejas). Las ventanas que se cierran no cuentan.'
                },
                {
                    id: 'ventilation_size',
                    text: '¬øQu√© tama√±o tiene esa ventilaci√≥n (en metros cuadrados)?',
                    type: 'number',
                    helpText: `Mide el ANCHO y el ALTO de tu reja. Si mide 2m de ancho por 3m de alto, son 6 metros cuadrados. El m√≠nimo es ${VENTILATIONMINAREA} m¬≤.`,
                    critical: true,
                    condition: (answer) => parseFloat(answer) >= VENTILATIONMINAREA,
                    failureMessage: `La ventilaci√≥n debe ser de al menos ${VENTILATIONMINAREA} metros cuadrados para asegurar que el gas escape si hay una fuga.`
                },
                {
                    id: 'businesses',
                    text: '‚ö†Ô∏è ¬°Atenci√≥n! ¬øAlguno de tus vecinos (costados, atr√°s, frente) tiene un taller de soldadura, mec√°nica, carpinter√≠a o un negocio que bote chispas?',
                    type: 'binary',
                    options: ['S√≠, hay un taller cerca', 'No, son casas o bodegas'],
                    critical: true,
                    condition: (answer) => answer === 'No, son casas o bodegas',
                    failureMessage: 'No puedes almacenar gas cerca de negocios que generen chispas (talleres, soldadura) por alto riesgo de explosi√≥n.'
                },
                {
                    id: 'transformer_nearby',
                    text: '¬øHay alg√∫n transformador el√©ctrico (ese gris en el poste) cerca?',
                    type: 'binary',
                    options: ['S√≠, hay uno cerca', 'No hay ninguno cerca'],
                    critical: false 
                },
                {
                    id: 'transformer_distance',
                    text: '¬øA cu√°ntos metros est√° el transformador de tu ALMAC√âN?',
                    type: 'number',
                    helpText: `Mide en l√≠nea recta desde el borde de tu almac√©n hasta el transformador. El m√≠nimo es ${TRANSFORMERMINDISTANCE} metros.`,
                    critical: true,
                    dependsOn: { id: 'transformer_nearby', value: 'S√≠, hay uno cerca' }, 
                    condition: (answer) => parseFloat(answer) >= TRANSFORMERMINDISTANCE,
                    failureMessage: `La distancia m√≠nima al transformador debe ser ${TRANSFORMERMINDISTANCE} metros.`
                },
                {
                    id: 'materials_roof',
                    text: '¬øDe qu√© material es el TECHO de tu almac√©n?',
                    type: 'options',
                    options: ['Ladrillo / Cemento (Noble)', 'Madera / Quincha', 'Estera / Pl√°stico / Calamina'],
                    critical: true,
                    condition: (answer) => answer === 'Ladrillo / Cemento (Noble)',
                    failureMessage: 'El TECHO no puede ser de material inflamable (madera, estera, pl√°stico, calamina sobre madera).'
                },
                {
                    id: 'materials_floor',
                    text: '¬øDe qu√© material es el PISO de tu almac√©n?',
                    type: 'options',
                    options: ['Cemento / Concreto / Loseta', 'Tierra / Afirmado', 'Madera / Pl√°stico / Vin√≠lico'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Concreto / Loseta' || answer === 'Tierra / Afirmado',
                    failureMessage: 'El PISO no puede ser de material inflamable (madera, pl√°stico, vin√≠lico).'
                },
                {
                    id: 'materials_walls',
                    text: '¬øDe qu√© material son las PAREDES de tu almac√©n?',
                    type: 'options',
                    options: ['Ladrillo / Cemento (Noble)', 'Madera / Quincha', 'Estera / Pl√°stico / Drywall'],
                    critical: true,
                    condition: (answer) => answer === 'Ladrillo / Cemento (Noble)',
                    failureMessage: 'Las PAREDES no pueden ser de material inflamable (madera, estera, drywall).'
                },
                {
                    id: 'haselectricityrecommendation',
                    text: '¬øHay cables el√©ctricos, enchufes o tomacorrientes DENTRO del almac√©n?',
                    type: 'binary',
                    options: ['S√≠, hay cables/enchufes', 'No, no hay nada el√©ctrico'],
                    critical: false,
                    recommendationMessage: 'RECOMENDACI√ìN: Debes retirar todas las conexiones el√©ctricas (cables, enchufes, focos) del interior del almac√©n.'
                },
                {
                    id: 'storage_dimensions',
                    text: 'Ingresa las medidas TOTALES de tu almac√©n (en metros):',
                    type: 'dimensions',
                    helpText: `¬°Importante! La norma exige 4.6 metros de espacio libre entre los balones y cualquier pared. Esto significa que tu cuarto debe tener un LARGO y ANCHO total de al menos ${MINDIMENSIONTOTAL} metros (9.2m) cada uno.`,
                    critical: true,
                    condition: (answer) => parseFloat(answer.largo) >= MINDIMENSIONTOTAL && parseFloat(answer.ancho) >= MINDIMENSIONTOTAL,
                    failureMessage: `El espacio es muy peque√±o. Para cumplir la norma de 4.6m de despeje, tu local debe medir al menos ${MINDIMENSIONTOTAL} x ${MINDIMENSIONTOTAL} metros.`
                }
            ],
            3: [
                {
                    id: 'businesses',
                    text: '‚ö†Ô∏è ¬°Atenci√≥n! ¬øAlguno de tus vecinos (costados, atr√°s, frente) tiene un taller de soldadura, mec√°nica, carpinter√≠a o un negocio que bote chispas?',
                    type: 'binary',
                    options: ['S√≠, hay un taller cerca', 'No, son casas o bodegas'],
                    critical: true,
                    condition: (answer) => answer === 'No, son casas o bodegas',
                    failureMessage: 'No puedes almacenar gas cerca de negocios que generen chispas (talleres, soldadura) por alto riesgo de explosi√≥n.'
                },
                {
                    id: 'transformer_nearby',
                    text: '¬øHay alg√∫n transformador el√©ctrico (ese gris en el poste) cerca?',
                    type: 'binary',
                    options: ['S√≠, hay uno cerca', 'No hay ninguno cerca'],
                    critical: false
                },
                {
                    id: 'transformer_distance',
                    text: '¬øA cu√°ntos metros est√° el transformador de tu √ÅREA de almac√©n?',
                    type: 'number',
                    helpText: `Mide en l√≠nea recta desde el borde de tu almac√©n hasta el transformador. El m√≠nimo es ${TRANSFORMERMINDISTANCE} metros.`,
                    critical: true,
                    dependsOn: { id: 'transformer_nearby', value: 'S√≠, hay uno cerca' }, 
                    condition: (answer) => parseFloat(answer) >= TRANSFORMERMINDISTANCE,
                    failureMessage: `La distancia m√≠nima al transformador debe ser ${TRANSFORMERMINDISTANCE} metros.`
                },
                {
                    id: 'materials_roof',
                    text: '¬øUsar√°s alg√∫n toldo o techo temporal sobre el √°rea?',
                    type: 'binary',
                    options: ['S√≠, pondr√© un toldo/techo', 'No, estar√° a cielo abierto'],
                    critical: true,
                    condition: (answer) => answer === 'No, estar√° a cielo abierto',
                    failureMessage: 'En un local "Sin Techo", el √°rea de balones debe estar a cielo abierto, sin toldos o coberturas inflamables.'
                },
                 {
                    id: 'materials_floor',
                    text: '¬øDe qu√© material es el PISO de tu almac√©n?',
                    type: 'options',
                    options: ['Cemento / Concreto / Loseta', 'Tierra / Afirmado', 'Madera / Pl√°stico / Grass'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Concreto / Loseta' || answer === 'Tierra / Afirmado',
                    failureMessage: 'El PISO no puede ser de material inflamable (madera, pl√°stico, grass).'
                },
                {
                    id: 'materials_walls',
                    text: '¬øDe qu√© material son las PAREDES que rodean el almac√©n?',
                    type: 'options',
                    options: ['Ladrillo / Cemento (Noble)', 'Madera / Quincha', 'Estera / Pl√°stico / Drywall'],
                    critical: true,
                    condition: (answer) => answer === 'Ladrillo / Cemento (Noble)',
                    failureMessage: 'Las PAREDES que rodean el local no pueden ser de material inflamable (madera, estera, drywall).'
                },
                {
                    id: 'haselectricityrecommendation',
                    text: '¬øPasan cables el√©ctricos o hay enchufes en esa √°rea?',
                    type: 'binary',
                    options: ['S√≠, hay cables/enchufes', 'No, no hay nada el√©ctrico'],
                    critical: false,
                    recommendationMessage: 'RECOMENDACI√ìN: Debes retirar todas las conexiones el√©ctricas (cables, enchufes) del √°rea de almacenamiento.'
                },
                {
                    id: 'storage_dimensions',
                    text: 'Ingresa las medidas TOTALES de tu √°rea de almac√©n (en metros):',
                    type: 'dimensions',
                    helpText: `¬°Importante! La norma exige 4.6 metros de espacio libre entre los balones y cualquier pared. Esto significa que tu √°rea debe tener un LARGO y ANCHO total de al menos ${MINDIMENSIONTOTAL} metros (9.2m) cada uno.`,
                    critical: true,
                    condition: (answer) => parseFloat(answer.largo) >= MINDIMENSIONTOTAL && parseFloat(answer.ancho) >= MINDIMENSIONTOTAL,
                    failureMessage: `El espacio es muy peque√±o. Para cumplir la norma de 4.6m de despeje, tu √°rea debe medir al menos ${MINDIMECTIONTOTAL} x ${MINDIMENSIONTOTAL} metros.`
                }
            ]
        };

        // --- VARIABLES GLOBALES ---
        let currentStep = 1;
        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentQuestionSet = [];
        let userData = {
            dni: '',
            option: '',
            optionText: '',
            answers: {},
            result: '',
            failures: [],
            recommendations: []
        };
        let totalQuestions = 0;

        // --- ELEMENTOS DOM ---
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progress');
        const dniInput = document.getElementById('dni');
        const saveDniBtn = document.getElementById('saveDni');
        const dniMessage = document.getElementById('dniMessage');
        const wizardContainer = document.getElementById('wizard-container');
        const optionCards = document.querySelectorAll('.option-card');
        const questionDisplay = document.getElementById('question-display');
        const nextQuestionBtn = document.getElementById('nextQuestion');
        const prevQuestionBtn = document.getElementById('prevQuestion');
        const resultContainer = document.getElementById('result-container');
        const restartBtn = document.getElementById('restart');
        const declaration = document.getElementById('declaration');
        const declDni = document.getElementById('decl-dni');
        const declarationContent = document.getElementById('declaration-content');
        const printDeclarationBtn = document.getElementById('printDeclaration');

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function () {
            saveDniBtn.addEventListener('click', saveDni);
            dniInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') saveDni(); });

            optionCards.forEach(card => {
                card.addEventListener('click', function () {
                    selectOption(this);
                    setTimeout(goToStep2, 300); 
                });
            });

            nextQuestionBtn.addEventListener('click', nextQuestion);
            prevQuestionBtn.addEventListener('click', prevQuestion);
            restartBtn.addEventListener('click', restartEvaluation);
            printDeclarationBtn.addEventListener('click', printDeclaration);
        });

        // --- FUNCIONES PRINCIPALES ---

        function saveDni() {
            const dni = dniInput.value.trim();
            if (dni.length === 8 && /^[0-9]+$/.test(dni)) {
                userData.dni = dni;
                dniMessage.textContent = '‚úì DNI guardado. ¬°Comencemos!';
                dniMessage.style.color = 'green';
                dniInput.disabled = true;
                saveDniBtn.disabled = true;
                wizardContainer.style.display = 'block';
                updateProgress();
            } else {
                dniMessage.textContent = 'Ingresa un DNI v√°lido (8 n√∫meros).';
                dniMessage.style.color = 'red';
            }
        }

        function selectOption(card) {
            optionCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedOption = card.getAttribute('data-option');
            currentQuestionSet = questionSets[selectedOption];
            totalQuestions = currentQuestionSet.length;
            
            userData.option = selectedOption;
            userData.optionText = card.querySelector('h3').textContent;
        }

        function goToStep(stepNumber) {
            currentStep = stepNumber;
            steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNumber}`).classList.add('active');
            updateProgress();
        }

        function goToStep2() {
            if (!selectedOption) return;
            currentQuestionIndex = 0;
            userData.answers = {}; 
            showQuestion(currentQuestionIndex);
            goToStep(2);
        }

        function updateProgress() {
            let progressPercent = 0;
            if (currentStep === 1) {
                progressPercent = 5;
            } else if (currentStep === 2) {
                progressPercent = 10 + (currentQuestionIndex / totalQuestions) * 80;
            } else if (currentStep === 3) {
                progressPercent = 100;
            }
            progressBar.style.width = `${progressPercent}%`;
        }

        // --- L√ìGICA DEL ASISTENTE (PASO 2) ---

        function showQuestion(index) {
            questionDisplay.innerHTML = '';
            
            // Si el √≠ndice est√° fuera de rango, manejar navegaci√≥n
            if (index < 0 || index >= totalQuestions) {
                if (index < 0) {
                    goToStep(1);
                    return;
                } else {
                    evaluateAnswers();
                    return;
                }
            }

            const question = currentQuestionSet[index];
            
            // Verificar dependencias
            if (question.dependsOn) {
                const dependency = question.dependsOn;
                const dependencyAnswer = userData.answers[dependency.id];
                
                // Si la dependencia no se cumple, saltar esta pregunta
                if (dependencyAnswer !== dependency.value) {
                    userData.answers[question.id] = 'N/A (Saltada)';
                    // Mostrar la siguiente pregunta
                    showQuestion(index + 1);
                    return;
                }
            }

            currentQuestionIndex = index;
            
            // Mostrar pregunta
            const qText = document.createElement('div');
            qText.className = 'question-text';
            qText.textContent = question.text;
            questionDisplay.appendChild(qText);
            
            // Mostrar texto de ayuda si existe
            if (question.helpText) {
                const qHelp = document.createElement('div');
                qHelp.className = 'help-text';
                qHelp.textContent = `üí° ${question.helpText}`;
                questionDisplay.appendChild(qHelp);
            }

            const qOptions = document.createElement('div');
            const savedAnswer = userData.answers[question.id];

            switch (question.type) {
                case 'binary':
                case 'options':
                    qOptions.className = `answer-options ${question.type === 'binary' ? 'binary' : ''}`;
                    
                    question.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn-option';
                        btn.textContent = opt;
                        
                        // Marcar como seleccionado si ya fue respondido
                        if (savedAnswer === opt) {
                            btn.classList.add('selected');
                        }
                        
                        btn.onclick = () => {
                            // Remover selecci√≥n anterior
                            qOptions.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                            // Seleccionar actual
                            btn.classList.add('selected');
                            // Guardar respuesta
                            userData.answers[question.id] = opt;
                            
                            // Avanzar autom√°ticamente si es la √∫ltima pregunta
                            if (currentQuestionIndex === totalQuestions - 1) {
                                setTimeout(evaluateAnswers, 500);
                            } else {
                                setTimeout(() => showQuestion(currentQuestionIndex + 1), 500);
                            }
                        };
                        qOptions.appendChild(btn);
                    });
                    break;
                    
                case 'number':
                    qOptions.className = 'answer-options';
                    
                    const inputContainer = document.createElement('div');
                    inputContainer.style.textAlign = 'center';
                    inputContainer.style.margin = '20px 0';
                    
                    const inputNum = document.createElement('input');
                    inputNum.type = 'number';
                    inputNum.placeholder = '0.0';
                    inputNum.step = '0.1';
                    inputNum.min = '0';
                    inputNum.style.fontSize = '1.2em';
                    inputNum.style.padding = '12px';
                    inputNum.style.width = '200px';
                    inputNum.style.textAlign = 'center';
                    
                    // Cargar valor guardado si existe
                    if (savedAnswer && savedAnswer !== 'N/A (Saltada)') {
                        inputNum.value = savedAnswer;
                    }
                    
                    inputNum.addEventListener('input', function() {
                        userData.answers[question.id] = this.value;
                    });
                    
                    inputContainer.appendChild(inputNum);
                    qOptions.appendChild(inputContainer);
                    break;
                    
                case 'dimensions':
                    qOptions.className = 'dimensions-grid';
                    
                    // Inicializar datos si no existen
                    if (!savedAnswer || typeof savedAnswer !== 'object') {
                        userData.answers[question.id] = { largo: '', ancho: '' };
                    }
                    
                    // Crear elementos de forma din√°mica
                    const labelLargo = document.createElement('label');
                    labelLargo.setAttribute('for', `dim-largo-${question.id}`);
                    labelLargo.textContent = 'Largo (m):';
                    
                    const inputLargo = document.createElement('input');
                    inputLargo.type = 'number';
                    inputLargo.id = `dim-largo-${question.id}`;
                    inputLargo.placeholder = 'Ej: 10.0';
                    inputLargo.step = '0.1';
                    inputLargo.min = '0';
                    inputLargo.value = userData.answers[question.id].largo || '';
                    
                    const labelAncho = document.createElement('label');
                    labelAncho.setAttribute('for', `dim-ancho-${question.id}`);
                    labelAncho.textContent = 'Ancho (m):';
                    
                    const inputAncho = document.createElement('input');
                    inputAncho.type = 'number';
                    inputAncho.id = `dim-ancho-${question.id}`;
                    inputAncho.placeholder = 'Ej: 10.0';
                    inputAncho.step = '0.1';
                    inputAncho.min = '0';
                    inputAncho.value = userData.answers[question.id].ancho || '';
                    
                    // Adjuntar eventos
                    inputLargo.addEventListener('input', function() {
                        userData.answers[question.id].largo = this.value;
                    });
                    
                    inputAncho.addEventListener('input', function() {
                        userData.answers[question.id].ancho = this.value;
                    });
                    
                    // Agregar elementos al contenedor
                    qOptions.appendChild(labelLargo);
                    qOptions.appendChild(inputLargo);
                    qOptions.appendChild(labelAncho);
                    qOptions.appendChild(inputAncho);
                    break;
            }
            
            questionDisplay.appendChild(qOptions);
            
            // Configurar botones de navegaci√≥n
            prevQuestionBtn.disabled = (index === 0);
            nextQuestionBtn.textContent = (index === totalQuestions - 1) ? 'Finalizar Evaluaci√≥n üèÅ' : 'Siguiente ‚û°Ô∏è';
            nextQuestionBtn.style.display = 'block';
            
            updateProgress();
        }

        function nextQuestion() {
            const question = currentQuestionSet[currentQuestionIndex];
            const answer = userData.answers[question.id];
            
            // Validar seg√∫n el tipo de pregunta
            let isValid = true;
            let errorMessage = '';
            
            if (question.type === 'binary' || question.type === 'options') {
                isValid = answer !== undefined && answer !== '';
                errorMessage = 'Por favor, selecciona una respuesta.';
            } 
            else if (question.type === 'number') {
                // Para n√∫mero, validar que sea un n√∫mero v√°lido y mayor o igual a 0
                const numValue = parseFloat(answer);
                isValid = !isNaN(numValue) && numValue >= 0;
                errorMessage = 'Por favor, ingresa un n√∫mero v√°lido mayor o igual a 0.';
            } 
            else if (question.type === 'dimensions') {
                const dims = answer || {};
                const largo = parseFloat(dims.largo);
                const ancho = parseFloat(dims.ancho);
                
                // Validar que ambos campos tengan valores v√°lidos y mayores a 0
                isValid = !isNaN(largo) && largo > 0 && !isNaN(ancho) && ancho > 0;
                errorMessage = 'Por favor, ingresa valores v√°lidos para largo y ancho (mayores a 0).';
            }
            
            if (!isValid) {
                alert(errorMessage);
                return;
            }
            
            // Navegar a la siguiente pregunta o finalizar
            if (currentQuestionIndex < totalQuestions - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                evaluateAnswers();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        // --- L√ìGICA DE EVALUACI√ìN (PASO 3) ---

        function evaluateAnswers() {
            userData.failures = [];
            userData.recommendations = [];
            let allCriticalPassed = true;
            
            let legal_limit = 0;
            let calculated_capacity = 0;
            let final_capacity = 0;
            let area = 0;
            let balonesCount = 0;

            // Revisar todas las preguntas
            currentQuestionSet.forEach(question => {
                const answer = userData.answers[question.id];
                
                if (answer === 'N/A (Saltada)') return; 
                
                if (question.critical && !question.condition(answer)) {
                    allCriticalPassed = false;
                    userData.failures.push(question.failureMessage);
                }
                
                if (!question.critical && question.recommendationMessage && !question.condition(answer)) {
                     userData.recommendations.push(question.recommendationMessage);
                }
            });

            // Si pas√≥, calcular capacidad
            if(allCriticalPassed) {
                userData.result = 'Aprobado';
                const answers = userData.answers;

                switch (selectedOption) {
                    case '1': // Rack
                        legal_limit = 120;
                        calculated_capacity = 120;
                        final_capacity = 120;
                        break;
                    
                    case '2': // Con Techo
                    case '3': // Sin Techo (L√≥gica de capacidad es la misma)
                        // Limpieza de datos antes de usar (por si acaso)
                        const dims = userData.answers.storage_dimensions || {};
                        const totalLargo = parseFloat(dims.largo || 0);
                        const totalAncho = parseFloat(dims.ancho || 0);
                        
                        const usableLargo = totalLargo - (WALL_CLEARANCE * 2);
                        const usableAncho = totalAncho - (WALL_CLEARANCE * 2);
                        
                        if (usableLargo > 0 && usableAncho > 0) {
                            area = usableLargo * usableAncho;
                            
                            const balonDiameter = 0.310;
                            const balonesPorFilaLargo = Math.floor(usableLargo / balonDiameter);
                            const balonesPorFilaAncho = Math.floor(usableAncho / balonDiameter);
                            const balonesPorNivel = balonesPorFilaLargo * balonesPorFilaAncho;
                            
                            // 2 niveles de balones
                            balonesCount = balonesPorNivel * 2; 
                            calculated_capacity = balonesCount * 10;
                        } else {
                            calculated_capacity = 0;
                            balonesCount = 0;
                        }
                        
                        legal_limit = (selectedOption === '2') ? 5000 : 50000;
                        final_capacity = Math.min(legal_limit, calculated_capacity);
                        break;
                }
                
                userData.capacity = {
                    legal_limit: legal_limit,
                    area: area,
                    calculated_capacity: calculated_capacity,
                    final_capacity: final_capacity,
                    balones_count: balonesCount
                };

            } else {
                userData.result = 'No Aprobado';
                userData.capacity = null;
            }

            showResults();
            goToStep(3);
        }

        function showResults() {
            resultContainer.innerHTML = '';
            let recommendationsHTML = '';
            
            if(userData.recommendations.length > 0) {
                userData.recommendations.forEach(rec => {
                    recommendationsHTML += `<div class="recommendation-item">${rec}</div>`;
                });
            }

            if (userData.result === 'Aprobado') {
                const cap = userData.capacity;
                let capacityHTML = '';

                if (selectedOption === '1') {
                     capacityHTML = `
                        <p>Tu modalidad es RACK/JAULA. El l√≠mite es fijo.</p>
                        <p class="final-capacity">Capacidad M√°xima: ${cap.final_capacity} kg</p>
                        <p><em>Para racks/jaulas la capacidad m√°xima permitida es de 120 kg</em></p>
                     `;
                } else {
                     const dims = userData.answers.storage_dimensions;
                     capacityHTML = `
                        <p>Tu espacio TOTAL mide: <strong>${parseFloat(dims.largo).toFixed(1)}m x ${parseFloat(dims.ancho).toFixed(1)}m</strong></p>
                        <p>√Årea √∫til para balones (restando 4.6m por lado): <strong>${cap.area.toFixed(2)} m¬≤</strong></p>
                        <p>N√∫mero m√°ximo de balones de 10kg en 2 niveles: <strong>${cap.balones_count} balones</strong></p>
                        <p>Tu l√≠mite legal para Local ${userData.optionText.replace('Hasta', '').trim()} es: <strong>${cap.legal_limit.toLocaleString()} kg</strong></p>
                        <p>Tu capacidad por espacio √∫til es: <strong>${cap.calculated_capacity.toLocaleString()} kg</strong></p>
                        <hr style="margin: 10px 0;">
                        <p class="final-capacity">Capacidad M√°xima Aprobada: ${cap.final_capacity.toLocaleString()} kg</p>
                        <small>(Se aprueba el valor m√°s bajo entre el l√≠mite legal y el de tu espacio)</small>
                    `;
                }

                resultContainer.innerHTML = `
                    <div class="result success">
                        <div class="result-icon">üéâ</div>
                        <h3>¬°Felicidades! Local APROBADO</h3>
                        <p>Has pasado la pre-evaluaci√≥n de seguridad. Tu espacio cumple con los requisitos cr√≠ticos.</p>
                        
                        <div class="capacity-box">
                            ${capacityHTML}
                        </div>
                        
                        <p style="margin-top: 15px; font-weight: bold;">Ac√©rcate a la oficina de Osinergmin con tu DNI. Tus respuestas est√°n guardadas para generar tu Declaraci√≥n Jurada.</p>
                    </div>
                     ${recommendationsHTML}
                `;
            } else {
                let failuresHTML = '<div class="failures-list"><h4>Debes corregir los siguientes puntos cr√≠ticos:</h4>';
                userData.failures.forEach(fail => {
                    failuresHTML += `<div class="failure-item">‚ùå ${fail}</div>`;
                });
                failuresHTML += '</div>';

                resultContainer.innerHTML = `
                    <div class="result danger">
                        <div class="result-icon">üö´</div>
                        <h3>Local NO APROBADO</h3>
                        <p>Tu espacio no cumple con uno o m√°s requisitos cr√≠ticos de seguridad.</p>
                        ${failuresHTML}
                        <p style="margin-top:20px;">Por favor, realiza las mejoras y vuelve a intentarlo. ¬°Estamos para ayudarte!</p>
                    </div>
                    ${recommendationsHTML}
                `;
            }

            if (userData.dni) {
                localStorage.setItem(`evaluacion_${userData.dni}`, JSON.stringify(userData));
            }
            generateDeclaration();
            declaration.classList.remove('hidden');
        }

        function generateDeclaration() {
            declDni.textContent = userData.dni || 'No registrado';
            let contenido = `
                <p><strong>Tipo de Almac√©n:</strong> ${userData.optionText}</p>
                <p><strong>Resultado:</strong> ${userData.result}</p>
                
                ${userData.result === 'Aprobado' ? `<p><strong>Capacidad Aprobada:</strong> ${userData.capacity.final_capacity} kg</p>` : ''}
                
                <strong>Respuestas Marcadas:</strong>
                <ul>
            `;
            
            currentQuestionSet.forEach(q => {
                const answer = userData.answers[q.id];
                let answerText = answer;

                if(typeof answer === 'object' && answer !== null) {
                    answerText = `Largo: ${answer.largo}m, Ancho: ${answer.ancho}m`;
                }
                
                if(answer !== 'N/A (Saltada)') {
                     contenido += `<li><strong>${q.text}:</strong> ${answerText}</li>`;
                }
            });
            
            contenido += `</ul>`;
            
            if (userData.failures.length > 0) {
                 contenido += `<p><strong>Puntos Cr√≠ticos Fallidos:</strong></p><ul>`;
                 userData.failures.forEach(f => { contenido += `<li>${f}</li>`; });
                 contenido += `</ul>`;
            }
            if (userData.recommendations.length > 0) {
                 contenido += `<p><strong>Recomendaciones (No Cr√≠ticas):</strong></p><ul>`;
                 userData.recommendations.forEach(r => { contenido += `<li>${r}</li>`; });
                 contenido += `</ul>`;
            }

            declarationContent.innerHTML = contenido;
        }

        function printDeclaration() {
            window.print();
        }

        function restartEvaluation() {
            currentStep = 1;
            currentQuestionIndex = 0;
            selectedOption = null;
            currentQuestionSet = [];
            userData.option = '';
            userData.optionText = '';
            userData.answers = {};
            userData.result = '';
            userData.failures = [];
            userData.recommendations = [];
            
            optionCards.forEach(card => card.classList.remove('selected'));
            declaration.classList.add('hidden');
            questionDisplay.innerHTML = '';
            
            // Habilitar el input de DNI para que pueda iniciar sesi√≥n de nuevo si lo desea
            dniInput.disabled = false;
            saveDniBtn.disabled = false;
            dniMessage.textContent = '';
            
            goToStep(1);
            updateProgress();
        }
    </script>
</body>
</html>
