<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osinergmin - Asistente de Formalizaci√≥n</title>
    <style>
        :root {
            --primary: #005A9C; /* Azul Osinergmin */
            --secondary: #00A9E0; /* Celeste Osinergmin */
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        /* Ocultar pasos */
        .step { display: none; }
        .step.active { display: block; }
        
        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
            text-align: center;
        }

        /* ----- Estilos de Selecci√≥n de Opciones (Paso 1) ----- */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .option-card {
            border: 2px solid var(--light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }
        .option-card:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .option-card.selected {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(0);
        }
        .option-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .option-card h3 {
            color: var(--dark);
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .option-card p {
            font-size: 0.9em;
            color: #777;
        }

        /* ----- Estilos del Asistente (Paso 2) ----- */
        #question-display {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .question-text {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            text-align: center;
        }
        .help-text {
            font-size: 0.9em;
            color: #555;
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .answer-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        /* Botones grandes para S√≠/No/Opciones */
        .btn-option {
            display: block;
            width: 100%;
            background-color: #fff;
            color: var(--dark);
            padding: 20px;
            border: 2px solid var(--light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }
        .btn-option:hover {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.05);
        }
        .btn-option.selected {
            border-color: var(--secondary);
            background-color: rgba(0, 169, 224, 0.1);
            color: var(--primary);
        }
        /* Botones para S√≠ y No en la misma fila */
        .answer-options.binary {
             grid-template-columns: 1fr 1fr;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="number"] {
            font-size: 1.2em;
            text-align: center;
            font-weight: bold;
        }

        /* ----- Botones de Navegaci√≥n ----- */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #007bbd;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-prev {
            background-color: var(--dark);
        }
        .btn-prev:hover {
            background-color: #4a637c;
        }
        .btn-eval {
            background-color: var(--success);
        }
        .btn-eval:hover {
            background-color: #219653;
        }

        /* ----- Resultados (Paso 3) ----- */
        .result {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .result h3 { font-size: 1.8em; margin-bottom: 10px; }
        .result-icon { font-size: 4em; margin-bottom: 15px; }
        
        .success {
            background-color: rgba(39, 174, 96, 0.1);
            border: 2px solid var(--success);
            color: #219653;
        }
        .warning {
            background-color: rgba(231, 76, 60, 0.1);
            border: 2px solid var(--danger);
            color: #c0392b;
        }
        .recommendations {
            margin-top: 20px;
            text-align: left;
        }
        .recommendation-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid var(--warning);
            background-color: rgba(243, 156, 18, 0.1);
            color: #d35400;
            font-weight: 500;
        }
        .recommendation-item.critical {
            border-left-color: var(--danger);
            background-color: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            font-weight: bold;
        }

        /* ----- Otros ----- */
        .progress-bar {
            height: 10px;
            background-color: var(--light);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: var(--secondary);
            width: 0%;
            transition: width 0.5s ease;
        }
        .dni-section {
            background-color: rgba(0, 169, 224, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        .declaration {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üõ°Ô∏è Osinergmin</div>
            <div class="subtitle">Asistente de Pre-evaluaci√≥n para Venta de Gas</div>
        </header>

        <div class="dni-section card">
            <h2>¬°Hola! üëã</h2>
            <p style="text-align: center; margin-bottom: 20px;">Vamos a ayudarte a revisar si tu local cumple los requisitos de seguridad. Para guardar tu avance y usarlo en la oficina, ingresa tu DNI.</p>
            <div class="form-group">
                <label for="dni">Ingresa tu DNI (8 d√≠gitos):</label>
                <input type="tel" id="dni" placeholder="Ej: 12345678" maxlength="8" pattern="[0-9]{8}">
            </div>
            <button class="btn" id="saveDni">Guardar DNI y Empezar</button>
            <div id="dniMessage" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>
        </div>

        <div class="card" id="wizard-container" style="display: none;">
            
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>

            <div class="step active" id="step1">
                <h2>1. ¬øD√≥nde guardar√°s los balones?</h2>
                <div class="option-grid">
                    <div class="option-card" data-option="1">
                        <div class="option-icon">üè†</div>
                        <h3>Espacio CON Techo</h3>
                        <p>Almac√©n, cuarto, cochera techada, etc.</p>
                    </div>
                    <div class="option-card" data-option="2">
                        <div class="option-icon">‚òÄÔ∏è</div>
                        <h3>Espacio SIN Techo</h3>
                        <p>Patio, jard√≠n, √°rea al aire libre.</p>
                    </div>
                    <div class="option-card" data-option="3">
                        <div class="option-icon">üóÑÔ∏è</div>
                        <h3>En Rack (Jaula)</h3>
                        <p>En el frontis o retiro de la casa.</p>
                    </div>
                </div>
                </div>

            <div class="step" id="step2">
                <h2 id="question-title">2. Revisi√≥n de Seguridad</h2>
                <div id="question-display">
                    </div>
                <div class="navigation-buttons">
                    <button class="btn btn-prev" id="prevQuestion">‚¨ÖÔ∏è Anterior</button>
                    <button class="btn" id="nextQuestion">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="step" id="step3">
                <h2>Resultado de la Pre-evaluaci√≥n</h2>
                <div id="result-container">
                    </div>
                <button class="btn" id="restart">Revisar de Nuevo</button>
            </div>
        </div>

        <div class="declaration hidden" id="declaration">
            <h2>Declaraci√≥n Jurada</h2>
            <p><strong>DNI:</strong> <span id="decl-dni"></span></p>
            <p>Con esta fecha, declaro que las respuestas marcadas son verdaderas y reflejan la realidad de mi local.</p>
            <div id="declaration-content"></div>
            <button class="btn" id="printDeclaration">Imprimir DJ</button>
        </div>
    </div>

    <script>
        // --- PREGUNTAS (El cerebro del asistente) ---
        // Convertimos las preguntas de texto a opciones claras.
        const questions = {
            1: [ // Con Techo
                {
                    id: 'businesses',
                    text: '‚ö†Ô∏è ¬°Atenci√≥n! ¬øAlguno de tus vecinos (costados, atr√°s, frente) tiene un taller de soldadura, mec√°nica, carpinter√≠a o un negocio que bote chispas?',
                    type: 'binary',
                    options: ['S√≠, hay un taller cerca', 'No, son casas o bodegas'],
                    critical: true,
                    condition: (answer) => answer === 'No, son casas o bodegas',
                    failureMessage: '¬°Requisito Insubsistible! No puedes almacenar gas cerca de negocios que generen chispas (talleres, soldadura, etc.) por alto riesgo de explosi√≥n.'
                },
                {
                    id: 'ventilation_type',
                    text: '¬øLa ventilaci√≥n de tu almac√©n es PERMANENTE? (Ej: rejas, calados, un hueco que no se puede cerrar)',
                    type: 'binary',
                    options: ['S√≠, es permanente (rejas)', 'No, tiene ventanas o se cierra'],
                    critical: true,
                    condition: (answer) => answer === 'S√≠, es permanente (rejas)',
                    failureMessage: 'La ventilaci√≥n debe ser permanente (con rejas). Las ventanas que se cierran no cuentan.'
                },
                {
                    id: 'ventilation_size',
                    text: '¬øQu√© tama√±o tiene esa ventilaci√≥n (en metros cuadrados)?',
                    type: 'number',
                    helpText: 'Mide el ANCHO y el ALTO de tu reja. Si mide 2m de ancho por 3m de alto, son 6 metros cuadrados.',
                    critical: true,
                    condition: (answer) => parseFloat(answer) >= 6,
                    failureMessage: 'La ventilaci√≥n debe ser de al menos 6 metros cuadrados para asegurar que el gas escape si hay una fuga.'
                },
                {
                    id: 'transformer_nearby',
                    text: '¬øHay alg√∫n transformador el√©ctrico (esos grises en el poste) cerca de tu casa?',
                    type: 'binary',
                    options: ['S√≠, hay uno cerca', 'No hay ninguno cerca'],
                    critical: false // La criticidad la tiene la distancia
                },
                {
                    id: 'transformer_distance',
                    text: '¬øA cu√°ntos metros est√° el transformador de tu almac√©n?',
                    type: 'number',
                    helpText: 'Mide en l√≠nea recta desde el borde de tu almac√©n (donde ir√°n los balones) hasta el transformador.',
                    critical: true,
                    dependsOn: { id: 'transformer_nearby', value: 'S√≠, hay uno cerca' }, // Solo se muestra si la anterior fue "S√≠"
                    condition: (answer) => parseFloat(answer) >= 7.6,
                    failureMessage: '¬°Requisito Insubsistible! La distancia m√≠nima al transformador debe ser 7.6 metros. El riesgo el√©ctrico es muy alto.'
                },
                {
                    id: 'materials_roof',
                    text: '¬øDe qu√© material es el TECHO de tu almac√©n?',
                    type: 'options',
                    options: ['Cemento / Ladrillo / Noble', 'Madera', 'Estera / Pl√°stico / Calamina'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Ladrillo / Noble',
                    failureMessage: 'El TECHO no puede ser de material inflamable (madera, estera, pl√°stico).'
                },
                {
                    id: 'materials_floor',
                    text: '¬øDe qu√© material es el PISO de tu almac√©n?',
                    type: 'options',
                    options: ['Cemento / Concreto', 'Tierra / Afirmado', 'Madera / Pl√°stico'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Concreto' || answer === 'Tierra / Afirmado',
                    failureMessage: 'El PISO no puede ser de material inflamable (madera, pl√°stico).'
                },
                {
                    id: 'materials_walls',
                    text: '¬øDe qu√© material son las PAREDES de tu almac√©n?',
                    type: 'options',
                    options: ['Cemento / Ladrillo / Noble', 'Madera', 'Estera / Pl√°stico / Quincha'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Ladrillo / Noble',
                    failureMessage: 'Las PAREDES no pueden ser de material inflamable (madera, estera, quincha).'
                }
            ],
            2: [ // Sin Techo
                {
                    id: 'businesses',
                    text: '‚ö†Ô∏è ¬°Atenci√≥n! ¬øAlguno de tus vecinos (costados, atr√°s, frente) tiene un taller de soldadura, mec√°nica, carpinter√≠a o un negocio que bote chispas?',
                    type: 'binary',
                    options: ['S√≠, hay un taller cerca', 'No, son casas o bodegas'],
                    critical: true,
                    condition: (answer) => answer === 'No, son casas o bodegas',
                    failureMessage: '¬°Requisito Insubsistible! No puedes almacenar gas cerca de negocios que generen chispas (talleres, soldadura, etc.) por alto riesgo de explosi√≥n.'
                },
                {
                    id: 'transformer_nearby',
                    text: '¬øHay alg√∫n transformador el√©ctrico (esos grises en el poste) cerca de tu casa?',
                    type: 'binary',
                    options: ['S√≠, hay uno cerca', 'No hay ninguno cerca'],
                    critical: false
                },
                {
                    id: 'transformer_distance',
                    text: '¬øA cu√°ntos metros est√° el transformador de tu almac√©n?',
                    type: 'number',
                    helpText: 'Mide en l√≠nea recta desde el borde de tu almac√©n (donde ir√°n los balones) hasta el transformador.',
                    critical: true,
                    dependsOn: { id: 'transformer_nearby', value: 'S√≠, hay uno cerca' },
                    condition: (answer) => parseFloat(answer) >= 7.6,
                    failureMessage: '¬°Requisito Insubsistible! La distancia m√≠nima al transformador debe ser 7.6 metros. El riesgo el√©ctrico es muy alto.'
                },
                {
                    id: 'has_door',
                    text: '¬øEse espacio (patio) tiene una puerta que lo encierre?',
                    type: 'binary',
                    options: ['S√≠, tiene puerta', 'No, es abierto'],
                    critical: true,
                    condition: (answer) => answer === 'No, es abierto',
                    failureMessage: 'El espacio sin techo debe ser abierto, no un cuarto cerrado sin techo, para que el aire circule.'
                },
                {
                    id: 'has_electricity',
                    text: '¬øPasan cables el√©ctricos (de luz, tomacorrientes) por ese espacio?',
                    type: 'binary',
                    options: ['S√≠, hay cables', 'No hay cables el√©ctricos'],
                    critical: true,
                    condition: (answer) => answer === 'No hay cables el√©ctricos',
                    failureMessage: 'No debe haber ning√∫n tipo de instalaci√≥n el√©ctrica (cables, enchufes) en el √°rea de almacenamiento.'
                },
                {
                    id: 'materials_floor',
                    text: '¬øDe qu√© material es el PISO de ese espacio?',
                    type: 'options',
                    options: ['Cemento / Concreto', 'Tierra / Afirmado', 'Madera / Pl√°stico / Grass sint√©tico'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Concreto' || answer === 'Tierra / Afirmado',
                    failureMessage: 'El PISO no puede ser de material inflamable (madera, pl√°stico, grass).'
                },
                {
                    id: 'materials_walls',
                    text: '¬øDe qu√© material son las PAREDES que rodean ese espacio?',
                    type: 'options',
                    options: ['Cemento / Ladrillo / Noble', 'Madera', 'Estera / Pl√°stico / Quincha'],
                    critical: true,
                    condition: (answer) => answer === 'Cemento / Ladrillo / Noble',
                    failureMessage: 'Las PAREDES que rodean el patio no pueden ser de material inflamable.'
                }
            ],
            3: [ // En Rack
                {
                    id: 'has_retiro',
                    text: '¬øTu casa tiene un "retiro"? (Un espacio o jard√≠n entre tu puerta y la vereda/pista)',
                    type: 'binary',
                    options: ['S√≠, tengo retiro/jard√≠n', 'No, mi casa da a la vereda'],
                    critical: true,
                    condition: (answer) => answer === 'S√≠, tengo retiro/jard√≠n',
                    failureMessage: '¬°Requisito Insubsistible! Para usar un rack (jaula), es obligatorio tener un espacio de retiro. No puede estar en la vereda.'
                }
                // Aqu√≠ se podr√≠an agregar m√°s preguntas espec√≠ficas para el rack si las tuvieras.
            ]
        };

        // --- VARIABLES GLOBALES ---
        let currentStep = 1;
        let currentQuestionIndex = 0;
        let selectedOption = null;
        let userData = {
            dni: '',
            option: '',
            optionText: '',
            answers: {},
            result: '',
            recommendations: []
        };
        let totalQuestions = 0;

        // --- ELEMENTOS DOM ---
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progress');
        const dniInput = document.getElementById('dni');
        const saveDniBtn = document.getElementById('saveDni');
        const dniMessage = document.getElementById('dniMessage');
        const wizardContainer = document.getElementById('wizard-container');
        
        // Step 1
        const optionCards = document.querySelectorAll('.option-card');
        
        // Step 2
        const questionDisplay = document.getElementById('question-display');
        const nextQuestionBtn = document.getElementById('nextQuestion');
        const prevQuestionBtn = document.getElementById('prevQuestion');
        
        // Step 3
        const resultContainer = document.getElementById('result-container');
        const restartBtn = document.getElementById('restart');
        
        // Declaraci√≥n
        const declaration = document.getElementById('declaration');
        const declDni = document.getElementById('decl-dni');
        const declarationContent = document.getElementById('declaration-content');
        const printDeclarationBtn = document.getElementById('printDeclaration');

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function () {
            saveDniBtn.addEventListener('click', saveDni);
            dniInput.addEventListener('keyup', (e) => {
                if(e.key === 'Enter') saveDni();
            });

            optionCards.forEach(card => {
                card.addEventListener('click', function () {
                    selectOption(this);
                    // Ir al siguiente paso autom√°ticamente al seleccionar
                    setTimeout(goToStep2, 300); 
                });
            });

            nextQuestionBtn.addEventListener('click', nextQuestion);
            prevQuestionBtn.addEventListener('click', prevQuestion);
            
            restartBtn.addEventListener('click', restartEvaluation);
            printDeclarationBtn.addEventListener('click', printDeclaration);
        });

        // --- FUNCIONES ---

        function saveDni() {
            const dni = dniInput.value.trim();
            if (dni.length === 8 && /^[0-9]+$/.test(dni)) {
                userData.dni = dni;
                dniMessage.textContent = '‚úì DNI guardado. ¬°Comencemos!';
                dniMessage.style.color = 'green';
                dniInput.disabled = true;
                saveDniBtn.disabled = true;
                wizardContainer.style.display = 'block';
                updateProgress(); // Iniciar barra de progreso
            } else {
                dniMessage.textContent = 'Ingresa un DNI v√°lido (8 n√∫meros).';
                dniMessage.style.color = 'red';
            }
        }

        function selectOption(card) {
            optionCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedOption = card.getAttribute('data-option');
            userData.option = selectedOption;
            userData.optionText = card.querySelector('h3').textContent;
            
            // Contar total de preguntas (considerando condicionales)
            totalQuestions = questions[selectedOption].length; 
        }

        function goToStep(stepNumber) {
            currentStep = stepNumber;
            steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNumber}`).classList.add('active');
            updateProgress();
        }

        function goToStep2() {
            if (!selectedOption) return;
            currentQuestionIndex = 0;
            userData.answers = {}; // Limpiar respuestas si vuelve
            showQuestion(currentQuestionIndex);
            goToStep(2);
        }

        function updateProgress() {
            let progressPercent = 0;
            if (currentStep === 1) {
                progressPercent = 5; // Un peque√±o avance al inicio
            } else if (currentStep === 2) {
                // Progreso basado en preguntas
                progressPercent = 10 + (currentQuestionIndex / totalQuestions) * 80;
            } else if (currentStep === 3) {
                progressPercent = 100;
            }
            progressBar.style.width = `${progressPercent}%`;
        }

        // --- L√ìGICA DEL ASISTENTE (PASO 2) ---

        function showQuestion(index) {
            // Limpiar pregunta anterior
            questionDisplay.innerHTML = '';
            
            const question = questions[selectedOption][index];

            // --- L√≥gica de Preguntas Condicionales ---
            if (question.dependsOn) {
                const dependency = question.dependsOn;
                const dependencyAnswer = userData.answers[dependency.id];
                
                // Si la respuesta de la dependencia NO es la requerida, saltar esta pregunta
                if (dependencyAnswer !== dependency.value) {
                    // Guardar una respuesta "N/A" para esta pregunta saltada
                    userData.answers[question.id] = 'N/A (Saltada)';
                    // Decidir si ir adelante o atr√°s
                    const direction = index > currentQuestionIndex ? 1 : -1;
                    const nextIndex = index + direction;

                    if (nextIndex >= 0 && nextIndex < totalQuestions) {
                        showQuestion(nextIndex); // Saltar a la siguiente/anterior
                    } else if (nextIndex >= totalQuestions) {
                        evaluateAnswers(); // Si era la √∫ltima, evaluar
                    } else {
                        goToStep(1); // Si era la primera, ir al paso 1
                    }
                    return; // Detener ejecuci√≥n
                }
            }

            // Actualizar √≠ndice global
            currentQuestionIndex = index;
            
            // Crear el texto de la pregunta
            const qText = document.createElement('div');
            qText.className = 'question-text';
            qText.textContent = question.text;
            questionDisplay.appendChild(qText);
            
            // A√±adir texto de ayuda si existe
            if (question.helpText) {
                const qHelp = document.createElement('div');
                qHelp.className = 'help-text';
                qHelp.textContent = `üí° ¬øC√≥mo mido esto? ${question.helpText}`;
                questionDisplay.appendChild(qHelp);
            }

            // Crear las opciones de respuesta
            const qOptions = document.createElement('div');
            qOptions.className = 'answer-options';
            
            const savedAnswer = userData.answers[question.id];

            switch (question.type) {
                case 'binary':
                    qOptions.classList.add('binary');
                    question.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn-option';
                        btn.textContent = opt;
                        if(opt === savedAnswer) btn.classList.add('selected');
                        btn.onclick = () => {
                            // Guardar respuesta y avanzar autom√°ticamente
                            userData.answers[question.id] = opt;
                            // Resaltar selecci√≥n
                            qOptions.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            // Avanzar
                            setTimeout(nextQuestion, 200);
                        };
                        qOptions.appendChild(btn);
                    });
                    break;
                case 'options':
                    question.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn-option';
                        btn.textContent = opt;
                        if(opt === savedAnswer) btn.classList.add('selected');
                        btn.onclick = () => {
                            userData.answers[question.id] = opt;
                            qOptions.querySelectorAll('.btn-option').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            setTimeout(nextQuestion, 200);
                        };
                        qOptions.appendChild(btn);
                    });
                    break;
                case 'number':
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.placeholder = '0.0';
                    input.value = (savedAnswer && savedAnswer !== 'N/A') ? savedAnswer : '';
                    input.onchange = () => {
                        userData.answers[question.id] = input.value;
                    };
                    qOptions.appendChild(input);
                    // Para n√∫meros, no avanzamos auto, el usuario usa el bot√≥n "Siguiente"
                    break;
            }
            
            questionDisplay.appendChild(qOptions);
            
            // Actualizar botones de navegaci√≥n
            prevQuestionBtn.disabled = (index === 0);
            nextQuestionBtn.textContent = (index === totalQuestions - 1) ? 'Finalizar Evaluaci√≥n üèÅ' : 'Siguiente ‚û°Ô∏è';
            
            // Ocultar "Siguiente" si es de botones (avanza solo)
            if(question.type === 'binary' || question.type === 'options') {
                nextQuestionBtn.style.display = 'none';
            } else {
                nextQuestionBtn.style.display = 'inline-block';
            }

            updateProgress();
        }

        function nextQuestion() {
            const question = questions[selectedOption][currentQuestionIndex];
            
            // Validar respuesta actual antes de avanzar
            if (!userData.answers[question.id]) {
                alert('Por favor, responde la pregunta.');
                return;
            }

            if (currentQuestionIndex < totalQuestions - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                // √öltima pregunta
                evaluateAnswers();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        // --- L√ìGICA DE EVALUACI√ìN (PASO 3) ---

        function evaluateAnswers() {
            const optionQuestions = questions[selectedOption];
            userData.recommendations = [];
            let allCriticalPassed = true;

            optionQuestions.forEach(question => {
                const answer = userData.answers[question.id];
                
                // Si la pregunta fue saltada (N/A), no la evaluamos
                if (answer === 'N/A (Saltada)') return; 
                
                if (question.critical && !question.condition(answer)) {
                    allCriticalPassed = false;
                    userData.recommendations.push({
                        message: question.failureMessage,
                        critical: question.failureMessage.includes('Insubsistible') // Marcar si es insubsistible
                    });
                }
            });

            userData.result = allCriticalPassed ? 'Aprobado' : 'Requiere Mejoras';
            showResults(allCriticalPassed);
            goToStep(3);
        }

        function showResults(allCriticalPassed) {
            resultContainer.innerHTML = '';
            if (allCriticalPassed) {
                resultContainer.innerHTML = `
                    <div class="result success">
                        <div class="result-icon">üéâ</div>
                        <h3>¬°Felicitaciones!</h3>
                        <p>Has pasado la pre-evaluaci√≥n de seguridad.</p>
                        <p style="margin-top: 15px; font-weight: bold;">Tu espacio cumple con los requisitos m√°s importantes. El siguiente paso es ir a la oficina.</p>
                        <p style="margin-top: 15px;">Ac√©rcate a Osinergmin con tu DNI. Tus respuestas ya est√°n guardadas para generar tu Declaraci√≥n Jurada.</p>
                    </div>
                `;
            } else {
                let recommendationsHTML = '<div class="recommendations"><h4>Debes corregir lo siguiente:</h4>';
                let hasCritical = false;
                
                userData.recommendations.forEach(rec => {
                    if (rec.critical) hasCritical = true;
                    recommendationsHTML += `<div class="recommendation-item ${rec.critical ? 'critical' : ''}">${rec.message}</div>`;
                });
                recommendationsHTML += '</div>';

                resultContainer.innerHTML = `
                    <div class="result warning">
                        <div class="result-icon">‚ö†Ô∏è</div>
                        <h3>¬°Atenci√≥n! Hay puntos por mejorar</h3>
                        <p>Tu espacio a√∫n no cumple con todos los requisitos de seguridad.</p>
                        ${hasCritical ? '<p style="margin-top:15px; font-weight:bold;">Detectamos un REQUISITO INSUBSISTIBLE. Esto significa que en este local NO es posible la formalizaci√≥n.</p>' : ''}
                        ${recommendationsHTML}
                        <p style="margin-top:20px;">Por favor, realiza las mejoras y vuelve a intentarlo. ¬°Estamos para ayudarte!</p>
                    </div>
                `;
            }

            // Guardar en LocalStorage y mostrar DJ
            if (userData.dni) {
                localStorage.setItem(`evaluacion_${userData.dni}`, JSON.stringify(userData));
            }
            generateDeclaration();
            declaration.classList.remove('hidden');
        }

        function generateDeclaration() {
            declDni.textContent = userData.dni || 'No registrado';
            let contenido = `
                <p><strong>Tipo de Almac√©n:</strong> ${userData.optionText}</p>
                <p><strong>Resultado:</strong> ${userData.result}</p>
                <strong>Respuestas Marcadas:</strong>
                <ul>
            `;
            
            questions[selectedOption].forEach(q => {
                const answer = userData.answers[q.id] || 'No respondida';
                // No mostrar preguntas saltadas en la DJ
                if(answer !== 'N/A (Saltada)') {
                     contenido += `<li><strong>${q.text}:</strong> ${answer}</li>`;
                }
            });
            
            contenido += `</ul>`;
            declarationContent.innerHTML = contenido;
        }

        function printDeclaration() {
            window.print();
        }

        function restartEvaluation() {
            currentStep = 1;
            currentQuestionIndex = 0;
            selectedOption = null;
            userData.option = '';
            userData.optionText = '';
            userData.answers = {};
            userData.result = '';
            userData.recommendations = [];
            
            optionCards.forEach(card => card.classList.remove('selected'));
            declaration.classList.add('hidden');
            questionDisplay.innerHTML = '';
            
            goToStep(1);
            updateProgress(); // Resetea la barra
        }
    </script>
</body>
</html>

